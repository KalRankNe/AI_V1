<!DOCTYPE html>
<html>
<head>
  <title>Real-time Image Classification with TensorFlow.js</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
  <h1>Real-time Image Classification with TensorFlow.js</h1>
  <video id="webcam" autoplay playsinline width="224" height="224"></video>
  <div id="prediction-result"></div>

  <script>
    let model;
    const webcamElement = document.getElementById('webcam');
    const predictionResult = document.getElementById('prediction-result');

    // 웹캠 스트리밍 시작
    async function setupWebcam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        webcamElement.srcObject = stream;
        webcamElement.onloadedmetadata = () => {
          webcamElement.play();
        };
      } catch (e) {
        console.error(e);
        alert('Webcam access denied.');
      }
    }

    // 모델 로드 및 웹캠 설정
    async function loadModelAndSetupWebcam() {
      model = await tf.loadLayersModel('../modeljs/model.json');
      await setupWebcam();
      predictLoop();
    }

    
   // 예측 루프
function predictLoop() {
  if (webcamElement.readyState === 4) { // 웹캠이 준비되었는지 확인
    const tensor = tf.browser.fromPixels(webcamElement)
      .resizeNearestNeighbor([224, 224])
      .toFloat()
      .expandDims();
    const prediction = model.predict(tensor);
    prediction.data().then(probabilities => { // 비동기적으로 예측 결과를 가져옵니다.
      const topPredictionIndex = probabilities.indexOf(Math.max(...probabilities)); // 가장 높은 확률의 인덱스를 찾습니다.
      predictionResult.innerText = `Predicted class: ${topPredictionIndex} with probability ${probabilities[topPredictionIndex]}`;
      tf.dispose(tensor);
      requestAnimationFrame(predictLoop); // 다음 프레임을 위해 예측 루프를 계속합니다.
    });
  } else {
    requestAnimationFrame(predictLoop); // 웹캠이 준비되지 않았다면, 다시 시도합니다.
  }
}



    loadModelAndSetupWebcam();
  </script>
</body>
</html>
